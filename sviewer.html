<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,shrink-to-fit=no"/>
	<title>Sviewer</title>
	<script type="text/javascript" src="webcomponents-lite.js"></script>
	<script type="text/javascript" src="node_modules/babel-polyfill/dist/polyfill.js"></script>
	<script type="text/javascript" src="dragdroptouch.js"></script>
 	<script type="text/javascript" src="glycan-bundle.js"></script>

 <style type="text/css">
#output svg * {
  -moz-transition: all 0.5s ease-in-out;
  -o-transition: all 0.5s ease-in-out;
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;
}
#output svg {
	width: 100%;
	height: 100%;
}
#existing {
	display: none;
}
#output {
	position: absolute;
	height: 80%;
	width: 80%;
}
g.tagged {
	filter: url(#membrane);
}
g.tagged line {
	stroke-width: 5;
}
.palette div {
	height: 100%;
}
body {
  margin: 0px;
  margin-top: 40px;
  margin-left: 20px;
  /* Disables pull-to-refresh but allows overscroll glow effects. */
  /*overscroll-behavior-y: contain;*/
/*  position: fixed;
*/
	overflow: hidden;
}

x-piemenu {
	position: absolute;
	top: 0px;
	left: 0px;
	pointer-events: none;
	width: 150px;
	height: 150px;
	z-index: 1;
	--end-angle: 60;
	--start-angle: -60;
}

x-piemenu[active] label {
	pointer-events: all;
}
x-piemenu button, x-piemenu label {
	font-family: sans-serif;
	font-size: 8px;
}
x-piemenu button.hover, x-piemenu label.hover, x-piemenu button:hover, x-piemenu label:hover {
	background: #6052E2;
	color: #ffffff;
}

label[draggable] {
	display: block;
}
label[draggable] input {
	/*display: none;*/
}

@media only screen
  and (min-device-width: 320px)
  and (max-device-width: 480px)
  and (-webkit-min-device-pixel-ratio: 2) {
	x-piemenu {
		--end-angle: 135;
		--start-angle: 35;
		--icon-position-ratio: 0.1;
		width: 200px;
		height: 200px;
	}

	x-piemenu button, x-piemenu label {
		font-family: sans-serif;
		font-size: 12px;
	}
}

</style>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="0" height="0">
	<defs>
    <filter id="membrane" filterUnits="objectBoundingBox">
      <feColorMatrix mode="matrix" in="SourceGraphic" values="0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 1 0" result="blacksource"/>
      <feGaussianBlur in="blacksource" stdDeviation="10" result="blur" />
      <feColorMatrix mode="matrix" in="blur" values="0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 30 -3" result="contrastup"/>
      <feColorMatrix mode="matrix" in="contrastup" values="0 0 0 0 0.9
                                                     0 0 0 0 0.8
                                                     0 0 0 0 0.8
                                                     0 0 0 0.6 0" result="googrey"/>
      <feMorphology operator="dilate" in="googrey" radius="2"/>
      <feColorMatrix mode="matrix" values="0 0 0 0 1
0 0 0 0 0.2
0 0 0 0 0.2
0 0 0 1 0" result="outeroutline"/>
      <feComposite in2="outeroutline" in="googrey" result="gooback"/>
      <feComposite in2="gooback" in="SourceGraphic"/>
	</filter>
	</defs>
</svg>
	<pre id="seqs" style="display: none;">
	</pre>
	<pre style="display:none;">
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc
		Gal(b1-3)[GlcNAc(b1-4)]GalNAc
		NeuAc(a2-6)[Fuc(a1-4)]Gal(b1-4)GlcNAc(b1-3)[NeuAc(a2-6)Gal(b1-4)GlcNAc(b1-6)]Gal(b1-4)GlcNAc(b1-2)Gal(b1-4)Glc
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-4)[NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)[NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]GalNAc(b1-4)GlcNAc(b1-2)GalNAc(b1-4)GlcNAc(b1-2)[Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
	</pre>
	<div class="palette" style="position: absolute; top: 0px; left: 0px; background-color: black; right: 0px; height: 50px; z-index: 1;">
	<div style="width: 50px; height: 50px; background: #fff; float: left;">
	</div>
	<form id="new_linkage">
	<x-piemenu name="anomer" id="anomer_menu">
  <label><span>a</span><input name="anomer" value="a" type="radio"></label>
  <label><span>b</span><input name="anomer" value="b" type="radio"></label>
  <label><span>?</span><input name="anomer" value="?" type="radio"></label>
	</x-piemenu>
	<x-piemenu name="linkage" id="linkage_menu">
  <label><span>2</span><input name="linkage" value="2" type="radio"></label>
  <label><span>3</span><input name="linkage" value="3" type="radio"></label>
  <label><span>4</span><input name="linkage" value="4" type="radio"></label>
  <label><span>6</span><input name="linkage" value="6" type="radio"></label>
  <label><span>8</span><input name="linkage" value="8" type="radio"></label>
	</x-piemenu>
	<label draggable="true" style="-webkit-user-drag: element; width: 50px; height: 50px; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neuac"</use>
	</svg>
	<input name="donor" value="NeuAc" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; width: 50px; height: 50px; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#gal"</use>
	</svg>
	<input name="donor" value="Gal" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; width: 50px; height: 50px; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#galnac"</use>
	</svg>
	<input name="donor" value="GalNAc" type="radio">
	</label>

	</form>
	</div>
	<textarea id="seq" style="display: none;" >NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc</textarea>
	<div id="output">
	</div>

<script type="text/javascript">
	let ticking = false;
	window.addEventListener('scroll', function(e) {

	  if (!ticking) {

	    window.requestAnimationFrame(function() {
		  let zoom = (window.innerWidth / document.documentElement.clientWidth).toFixed(2);
	      let top = window.scrollY;
	      document.getElementById('new_linkage').style.transformOrigin = `${window.scrollX}px ${top}px`;
		  document.getElementById('new_linkage').style.transform = `scale(${zoom}) translate(${window.scrollX}px,${top}px)`;
		  // console.log(document.getElementById('dragsource').style.transform);
	      ticking = false;
	    });
	    ticking = true;

	  }
	});

	let clear_sequences = function() {
		document.getElementById('output').innerHTML = '';
	};

	const tag_symbol = Symbol('tageroony');

	let global_renderer;

	let append_sequence = function(seq) {
		if ( ! seq ) {
			return;
		}
		if ( ! global_renderer ) {
			global_renderer = new Glycan.SVGRenderer(document.getElementById('output'),Glycan.FishEyeLayout);
		}
		console.log(seq);
		let sug = new Glycan.IupacSugar();
		sug.sequence = seq;
		sug.root.setTag(tag_symbol);
		sug.root.children[0].setTag(tag_symbol);
		if (sug.root.children[0].children.length > 0) {
			sug.root.children[0].children[0].setTag(tag_symbol);
		}
		Glycan.FishEyeLayout.LINKS = false;
		let renderer = global_renderer;//= new Glycan.SVGRenderer(output,Glycan.FishEyeLayout);

		renderer.groupTag = tag_symbol;

		renderer.addSugar(sug);

		let last_req = null;

		renderer.element.canvas.addEventListener('dragleave', (ev) => {
			if (ev.relatedTarget === renderer.element.canvas) {
				setTimeout(() =>{
					document.getElementById('anomer_menu').removeAttribute('active');
					document.getElementById('linkage_menu').removeAttribute('active');
					delete document.getElementById('new_linkage').residue;
				},100);
			}

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});
		document.body.addEventListener('dragend', (ev) => {
			setTimeout(() =>{
				document.getElementById('anomer_menu').removeAttribute('active');
				document.getElementById('linkage_menu').removeAttribute('active');
				delete document.getElementById('new_linkage').residue;
			},100);

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.element.canvas.addEventListener('dragover', (ev) => {
			if (
			document.getElementById('linkage_menu').hasAttribute('active') ||
			document.getElementById('anomer_menu').hasAttribute('active') ) {
				return;
			}

			Glycan.FishEyeLayout.focus = [ ev.svgX, ev.svgY ];
			let [min_x,min_y,width,height] = renderer.element.canvas.getAttribute('viewBox').split(' ').map( val => parseFloat(val) );
			Glycan.FishEyeLayout.zoom = Math.floor(height / 100);
			Glycan.FishEyeLayout.lock_residues = true;
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.refresh();
		renderer.scaleToFit();
		sug.composition().map( enableDropResidue.bind(null,renderer) );
	};
	let load_all_seqs = function() {
		clear_sequences();
		console.log("Here");
		for (let seq of document.getElementById('seqs').textContent.split('\n')) {
			append_sequence(seq.trim());
		}
		append_sequence(document.getElementById('seq').value);

	};

	show_anomer = function(residue,ev) {
		let anomer_chooser = document.getElementById('anomer_menu');
		let form = document.getElementById('new_linkage');
		console.log("Setting target to ",residue.identifier);
		delete form.active_residue;
		form.residue = residue;
		anomer_chooser.removeAttribute('active');
		let target_pos = ev.target.getBoundingClientRect();
		let left_pos = -0.5*anomer_chooser.getBoundingClientRect().width + target_pos.left + (target_pos.width / 2) + window.scrollX;
		let top_pos = -0.5*anomer_chooser.getBoundingClientRect().height + target_pos.top + (target_pos.height / 2) + window.scrollY;
		// let zoom = (window.innerWidth / document.documentElement.clientWidth).toFixed(2);
		let zoom = 1;
		anomer_chooser.style.transformOrigin = `${left_pos}px ${top_pos}px`;
		anomer_chooser.style.transform = `scale(${zoom}) translate(${left_pos}px,${top_pos}px)`;
		anomer_chooser.setAttribute('active',true);
		anomer_chooser.clear();
	};

	enableDropResidue = function(renderer,residue) {
		residue.renderer = renderer;
		let target = renderer.rendered.get(residue).residue;
		target.style.pointerEvents = 'all';
		let anomer_chooser = document.getElementById('anomer_menu');
		let form = document.getElementById('new_linkage');

		target.addEventListener('dragleave', (ev) => {
			delete form.active_residue;
			clearTimeout(form.residue_timeout);
		});
		target.addEventListener('click', show_anomer.bind(null,residue) );
		target.addEventListener('dragenter', (ev) => {
			let last_residue = form.active_residue;

			if (last_residue === residue) {
				return;
			}

			// We should wait for a drag over at least 300 ms after
			// to set the target
			last_residue = residue;
			form.active_residue = residue;

			if (form.residue_timeout) {
				clearTimeout(form.residue_timeout);
			}

			form.residue_timeout = setTimeout(show_anomer.bind(null,residue,ev),500);
		});
	};

	window.onload = function() {
		new Glycan.DragManager(document.body);
		new Glycan.DraggableForm(document.getElementById('new_linkage'));
		document.getElementById('new_linkage').addEventListener('submit', function(ev) {
			let new_res = new Glycan.Monosaccharide(this.donor.value);
			new_res.anomer = this.anomer.value;
			new_res.parent_linkage = this.donor.value.match(/Neu(Gc|Ac)/) ? 2 : 1;
			this.residue.addChild(parseInt(this.linkage.value),new_res);
			this.residue.balance();
			this.residue.renderer.refresh();
			enableDropResidue(this.residue.renderer,new_res);
			this.residue.renderer.scaleToFit();
			console.log(this.residue.renderer.sugars[0].sequence);
			this.reset();
		});

		load_all_seqs();
		document.getElementById('seq').onchange = function() {
			load_all_seqs();
		};
	};
</script>

</body>
</html>