<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,shrink-to-fit=no"/>
	<title>Sviewer</title>
	<script type="text/javascript" src="node_modules/babel-polyfill/dist/polyfill.js"></script>
	<script type="text/javascript" src="dragdroptouch.js"></script>
	<script type="text/javascript" src="glycan-bundle.js"></script>

 <style type="text/css">
  #input svg	* {
  -moz-transition: all 0.5s ease-in-out;
  -o-transition: all 0.5s ease-in-out;
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;
}
body {
  margin: 0px;
  margin-top: 40px;
  margin-left: 20px;
  /* Disables pull-to-refresh but allows overscroll glow effects. */
  /*overscroll-behavior-y: contain;*/
/*  position: fixed;
*/  overflow: hidden;
}
</style>
</head>
<body>
	<pre id="seqs" style="display: none;">
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc
		Gal(b1-3)[GlcNAc(b1-4)]GalNAc
		NeuAc(a2-6)[Fuc(a1-4)]Gal(b1-4)GlcNAc(b1-3)[NeuAc(a2-6)Gal(b1-4)GlcNAc(b1-6)]Gal(b1-4)GlcNAc(b1-2)Gal(b1-4)Glc
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-4)[NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)[NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]GalNAc(b1-4)GlcNAc(b1-2)GalNAc(b1-4)GlcNAc(b1-2)[Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
	</pre>
	<div draggable="true" id="dragsource" style="-webkit-user-drag: element; position: fixed; top: 20px; left: 20px; width: 50px; height: 50px;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neuac"</use>
	</svg>
	</div>
	<textarea id="seq" style="display: none;" >NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc</textarea>
	<div id="output">
	</div>
<script type="text/javascript">
	let clear_sequences = function() {
		document.getElementById('output').innerHTML = '';
	};
	let append_sequence = function(seq) {
		if ( ! seq ) {
			return;
		}
		console.log(seq);
		let sug = new Glycan.IupacSugar();
		sug.sequence = seq;
		let output = document.createElement('div');
		output.style.width = '150px';
		output.style.height = '150px';
		output.style.float = 'left';
		document.getElementById('output').appendChild(output);
		let renderer = new Glycan.SVGRenderer(output,Glycan.FishEyeLayout);
		renderer.addSugar(sug);
		// renderer.element.canvas.addEventListener('dragenter', (ev) => {
		// 	ev.preventDefault();
		// });

		let last_req = null;

		renderer.element.canvas.addEventListener('dragleave', (ev) => {
			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});
		renderer.element.canvas.addEventListener('dragover', (ev) => {
			Glycan.FishEyeLayout.focus = [ ev.svgX, ev.svgY ];
			let [min_x,min_y,width,height] = renderer.element.canvas.getAttribute('viewBox').split(' ').map( val => parseFloat(val) );
			Glycan.FishEyeLayout.zoom = Math.floor(height / 100);
			Glycan.FishEyeLayout.lock_residues = true;
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});
		/*setTimeout(function() {
			if ( Math.floor(Math.random()*10) >= 5 ) {
				if (sug.composition().length < 3) {
					return;
				}
				let removed = sug.leaves()[0];
				removed.parent.removeChild(removed.parent.linkageOf(removed),removed);
			} else {
				let residues = sug.composition();
				let targ = residues[Math.floor(Math.random()*residues.length)];
				if (targ.identifier === 'Fuc' || targ.identifier === 'NeuAc') {
					return;
				}
				let new_res = new Glycan.Monosaccharide('Gal');
				new_res.anomer = 'a';
				new_res.parent_link = 1;
				targ.addChild(4,new_res);
				targ = new_res;
			}
			renderer.refresh();
		},200);*/
		renderer.refresh();
		output.firstChild.style.width = '100%';
		output.firstChild.style.height = '100%';		
	};
	let load_all_seqs = function() {
		clear_sequences();
		console.log("Here");
		for (let seq of document.getElementById('seqs').textContent.split('\n')) {
			append_sequence(seq.trim());
		}
		append_sequence(document.getElementById('seq').value);		

	};

	var global_drags = {};

	//https://codepen.io/anon/pen/WdyZvY

	document.getElementById('dragsource').addEventListener('dragstart', function (evt) {
		// We'll handle this event so first stop bubbling up
		evt.stopPropagation();
		// If we'd like to prevent dragging because of some condition,
		// we'd simply call preventDefault() and be done here
		if (false) {
		  evt.preventDefault();
		  return;
		}
		// Now setup our dataTransfer object properly
		// First we'll allow a move action — this is used for the cursor
		evt.dataTransfer.effectAllowed = 'copy';
		evt.dataTransfer.dropEffect = 'copy';
		// Setup some dummy drag-data to ensure dragging
		let drag_id = 'drag/'+(new Date().getTime());
		evt.dataTransfer.setData(drag_id, '');

		global_drags[drag_id] = {'residue' : 'NeuAc', 'visited' : []};
		// Now we'll create a dummy image for our dragImage
		// var dragImage = document.createElement('div');
		// dragImage.setAttribute('style', 'position: absolute; left: 0px; top: 0px; width: 40px; height: 40px; background: red; z-index: -1');
		// document.body.appendChild(dragImage);
		// // And finally we assign the dragImage and center it on cursor
		// evt.dataTransfer.setDragImage(dragImage, 20, 20);
	});

	makeDragTarget = function(element) {
		element.style.pointerEvents = 'all';
		element.addEventListener('dragover', ev => ev.preventDefault() );
		element.addEventListener('dragenter', (ev) => {
			console.log('Drag enter');
			ev.preventDefault();
			let targets = ev.dataTransfer.types.filter( type => type.match(/^drag\/\d+/));
			console.log("Drag enter ",targets);
			for (let target of targets) {
				global_drags[target].visited.push(element.getAttribute('glycanjs:identifier'));
			}
		});
		element.addEventListener('drop', (ev) => {
			let targets = ev.dataTransfer.types.filter( type => type.match(/^drag\/\d+/));
			ev.visited = [];
			for (let target of targets) {
				ev.visited.push(global_drags[target].visited);
			}
		},{capture: true, passive: true});
	};

	window.onload = function() {
		load_all_seqs();
		document.getElementById('seq').onchange = function() {
			load_all_seqs();
		};
	};
</script>

</body>
</html>