<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,shrink-to-fit=no"/>
	<title>Sviewer</title>
	<script type="text/javascript" src="node_modules/babel-polyfill/dist/polyfill.js"></script>
	<script type="text/javascript" src="dragdroptouch.js"></script>
	<script type="text/javascript" src="glycan-bundle.js"></script>

 <style type="text/css">
#output svg * {
  -moz-transition: all 0.5s ease-in-out;
  -o-transition: all 0.5s ease-in-out;
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;
}
body {
  margin: 0px;
  margin-top: 40px;
  margin-left: 20px;
  /* Disables pull-to-refresh but allows overscroll glow effects. */
  /*overscroll-behavior-y: contain;*/
/*  position: fixed;
*/  overflow: hidden;
}
x-piemenu {
	position: absolute;
	pointer-events: none;
}
button {
	font-size: 3px;
}
button:hover {
	background: #f00;
}
</style>
</head>
<body>
	<x-piemenu id="pie" style="width: 100px; height: 100px;">
  <button><span>ABC</span></button>
  <button><span>DEF</span></button>
  <button><span>ABC</span></button>
<!--   <button><span>DEF</span></button>
  <button><span>ABC</span></button>
  <button><span>DEFG<br/>HIJK</span></button>
 -->	</x-piemenu>
	<pre id="seqs" style="display: none;">
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc
		Gal(b1-3)[GlcNAc(b1-4)]GalNAc
		NeuAc(a2-6)[Fuc(a1-4)]Gal(b1-4)GlcNAc(b1-3)[NeuAc(a2-6)Gal(b1-4)GlcNAc(b1-6)]Gal(b1-4)GlcNAc(b1-2)Gal(b1-4)Glc
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-4)[NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)[NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]GalNAc(b1-4)GlcNAc(b1-2)GalNAc(b1-4)GlcNAc(b1-2)[Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
	</pre>
	<div draggable="true" id="dragsource" style="-webkit-user-drag: element; position: fixed; top: 20px; left: 20px; width: 50px; height: 50px;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neuac"</use>
	</svg>
	</div>
	<textarea id="seq" style="display: none;" >NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc</textarea>
	<div id="output">
	</div>
<script type="text/javascript">
	let clear_sequences = function() {
		document.getElementById('output').innerHTML = '';
	};
	let append_sequence = function(seq) {
		if ( ! seq ) {
			return;
		}
		console.log(seq);
		let sug = new Glycan.IupacSugar();
		sug.sequence = seq;
		let output = document.createElement('div');
		output.style.width = '150px';
		output.style.height = '150px';
		output.style.float = 'left';
		document.getElementById('output').appendChild(output);
		let renderer = new Glycan.SVGRenderer(output,Glycan.FishEyeLayout);
		renderer.addSugar(sug);

		let last_req = null;

		renderer.element.canvas.addEventListener('dragleave', (ev) => {
			setTimeout(() =>{
				document.getElementById('pie').removeAttribute('active');
			},100);

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});
		document.body.addEventListener('dragend', (ev) => {
			setTimeout(() =>{
				document.getElementById('pie').removeAttribute('active');
			},100);

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.element.canvas.addEventListener('dragover', (ev) => {
			setTimeout(() => {
				document.getElementById('pie').setAttribute('active',true);
				document.getElementById('pie').style.top = (ev.clientY-50)+'px';
				document.getElementById('pie').style.left = (ev.clientX-50)+'px';
			},0);

			Glycan.FishEyeLayout.focus = [ ev.svgX, ev.svgY ];
			let [min_x,min_y,width,height] = renderer.element.canvas.getAttribute('viewBox').split(' ').map( val => parseFloat(val) );
			Glycan.FishEyeLayout.zoom = Math.floor(height / 100);
			Glycan.FishEyeLayout.lock_residues = true;
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		setInterval(function() {
			if ( Math.floor(Math.random()*10) >= 5 ) {
				if (sug.composition().length < 3) {
					return;
				}
				let removed = sug.leaves()[0];
				removed.parent.removeChild(removed.parent.linkageOf(removed),removed);
			} else {
				let residues = sug.composition();
				let targ = residues[Math.floor(Math.random()*residues.length)];
				if (targ.identifier === 'Fuc' || targ.identifier === 'NeuAc') {
					return;
				}
				let new_res = new Glycan.Monosaccharide('Gal');
				new_res.anomer = 'a';
				new_res.parent_link = 1;
				targ.addChild(4,new_res);
				targ = new_res;
			}
			renderer.refresh();
		},1000);
		renderer.refresh();
		output.firstChild.style.width = '100%';
		output.firstChild.style.height = '100%';
	};
	let load_all_seqs = function() {
		clear_sequences();
		console.log("Here");
		for (let seq of document.getElementById('seqs').textContent.split('\n')) {
			append_sequence(seq.trim());
		}
		append_sequence(document.getElementById('seq').value);

	};

	var global_drags = {};

	//https://codepen.io/anon/pen/WdyZvY

	document.body.addEventListener('dragstart', (evt) => {
		if ( ! evt.isTrusted ) {
			return;
		}
		// Setup some dummy drag-data to ensure dragging
		let drag_id = 'drag/'+(new Date().getTime());
		console.log(evt);
		evt.dataTransfer.setData(drag_id, '');
		evt.dataTransfer.effectAllowed = 'copy';
		evt.dataTransfer.dropEffect = 'copy';

		let target = evt.target;
		var event = new Event('dragstart');
		event.bubbles = false;
		event.dataTransfer = { types: [ drag_id ] };
		event.data = { };
		global_drags[drag_id] = event.data;
		target.dispatchEvent(event);
		evt.stopPropagation();
	},{capture: true});

	document.body.addEventListener('dragenter', (ev) => {
		let drag_id = ev.dataTransfer.types.filter( type => type.match(/^drag\/\d+/))[0];
		ev.data = global_drags[drag_id];
	},{capture: true});

	document.body.addEventListener('drop', (ev) => {
		let drag_id = ev.dataTransfer.types.filter( type => type.match(/^drag\/\d+/))[0];
		ev.data = global_drags[drag_id];
	},{capture: true});

	document.getElementById('dragsource').addEventListener('dragstart', function (evt) {
		evt.stopPropagation();
		// If we'd like to prevent dragging because of some condition,
		// we'd simply call preventDefault() and be done here
		if (false) {
		  evt.preventDefault();
		  return;
		}
		evt.data.residue = 'NeuAc';
		evt.data.visited = [];
	});

	document.getElementById('dragsource').addEventListener('dragend', (evt) => {
		document.getElementById('pie').removeAttribute('active');
	});

	makeDragTarget = function(element) {
		element.style.pointerEvents = 'all';
		element.addEventListener('dragover', ev => ev.preventDefault() );
		element.addEventListener('dragenter', (ev) => {
			ev.preventDefault();
			if (ev.data.visited.indexOf(element.getAttribute('glycanjs:identifier')) < 0) {
				ev.data.visited.push(element.getAttribute('glycanjs:identifier'));
			}
		});
		element.addEventListener('drop', (ev) => {
			console.log(ev.data);
		},{capture: false, passive: true});
	};

	window.onload = function() {
		load_all_seqs();
		document.getElementById('seq').onchange = function() {
			load_all_seqs();
		};
	};
</script>

</body>
</html>