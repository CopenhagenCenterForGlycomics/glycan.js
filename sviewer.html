<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,shrink-to-fit=no"/>
	<title>Sviewer</title>
	<script type="text/javascript" src="webcomponents-lite.js"></script>
	<script type="text/javascript" src="node_modules/babel-polyfill/dist/polyfill.js"></script>
	<script type="text/javascript" src="dragdroptouch.js"></script>
	<script type="text/javascript" src="glycan-bundle.js"></script>

 <style type="text/css">
#output svg * {
  -moz-transition: all 0.5s ease-in-out;
  -o-transition: all 0.5s ease-in-out;
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;
}
#output svg {
	width: 100%;
	height: 100%;
}
#existing {
	display: none;
}
#output {
	position: absolute;
	top: 0px;
	left: 0px;
	height: 100%;
	width: 100%;
}
g.tagged {
	filter: url(#membrane);
}
g.tagged line {
	stroke-width: 5;
}
#widget .palette {
	position: absolute;
	top: 0px;
	left: 0px;
	right: 0px;
	background: #eee;
}
body {
  margin: 0px;
/*  margin-top: 40px;
  margin-left: 20px;
*/  /* Disables pull-to-refresh but allows overscroll glow effects. */
  /*overscroll-behavior-y: contain;*/
/*  position: fixed;
*/
	overflow: hidden;
}

x-piemenu {
	position: absolute;
	top: 0px;
	left: 0px;
	pointer-events: none;
	width: 150px;
	height: 150px;
	z-index: 2;
	--end-angle: 60;
	--start-angle: -60;
	--icon-size: 10px;
}

x-piemenu[active] label {
	pointer-events: all;
}
x-piemenu button, x-piemenu label {
	font-family: sans-serif;
	font-size: var(--icon-size);
}

x-piemenu button.hover, x-piemenu label.hover, x-piemenu button:hover, x-piemenu label:hover {
	background: #6052E2;
	color: #ffffff;
}

label.checked {
	background: #faa;
}

label[draggable] {
	display: block;
	width: 25px;
	height: 25px;
}
label[draggable] input {
	display: none;
}

#widget {
	border: solid red 1px;
	width: 50%;
	position: absolute;
	height: 50%;
	left: 10%;
}

#widget div.widget_contents {
	position: absolute;
	left: 0px;
	right: 0px;
	top: 0px;
	bottom: 0px;
	width: 100%;
	height: 100%;
}

#widget .pie_parent {
	position: fixed;
	top: 0px;
	left: 0px;
	width: 100%;
	height: 100%;
	pointer-events: none;
	border: solid blue 1px;
}


@media only screen
  and (min-device-width: 320px)
  and (max-device-width: 480px)
  and (-webkit-min-device-pixel-ratio: 2) {
	x-piemenu {
		--end-angle: 135;
		--start-angle: 35;
		--icon-position-ratio: 0.1;
		--icon-size: 24px;
		width: 200px;
		height: 200px;
	}

/*	x-piemenu button, x-piemenu label {
		font-family: sans-serif;
		font-size: 12px;
	}
*/}

</style>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="0" height="0">
	<defs>
	<filter id="membrane" filterUnits="objectBoundingBox">
	  <feColorMatrix mode="matrix" in="SourceGraphic" values="0 0 0 0 0
													 0 0 0 0 0
													 0 0 0 0 0
													 0 0 0 1 0" result="blacksource"/>
	  <feGaussianBlur in="blacksource" stdDeviation="10" result="blur" />
	  <feColorMatrix mode="matrix" in="blur" values="0 0 0 0 0
													 0 0 0 0 0
													 0 0 0 0 0
													 0 0 0 30 -3" result="contrastup"/>
	  <feColorMatrix mode="matrix" in="contrastup" values="0 0 0 0 0.9
													 0 0 0 0 0.8
													 0 0 0 0 0.8
													 0 0 0 0.6 0" result="googrey"/>
	  <feMorphology operator="dilate" in="googrey" radius="2"/>
	  <feColorMatrix mode="matrix" values="0 0 0 0 1
0 0 0 0 0.2
0 0 0 0 0.2
0 0 0 1 0" result="outeroutline"/>
	  <feComposite in2="outeroutline" in="googrey" result="gooback"/>
	  <feComposite in2="gooback" in="SourceGraphic"/>
	</filter>
	</defs>
</svg>
	<pre id="seqs" style="display: none;">
	</pre>
	<pre style="display:none;">
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc
		Gal(b1-3)[GlcNAc(b1-4)]GalNAc
		NeuAc(a2-6)[Fuc(a1-4)]Gal(b1-4)GlcNAc(b1-3)[NeuAc(a2-6)Gal(b1-4)GlcNAc(b1-6)]Gal(b1-4)GlcNAc(b1-2)Gal(b1-4)Glc
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-4)[NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)[NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]GalNAc(b1-4)GlcNAc(b1-2)GalNAc(b1-4)GlcNAc(b1-2)[Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
	</pre>
	<div id="widget">
	<div class="widget_contents" >
	<div id="output">
	</div>
	<form id="new_linkage">
	<div style="float: left;"></div>
	<div class="palette">
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neuac"</use>
	</svg>
	<input name="donor" value="NeuAc" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#gal"</use>
	</svg>
	<input name="donor" value="Gal" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#galnac"</use>
	</svg>
	<input name="donor" value="GalNAc" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#man"</use>
	</svg>
	<input name="donor" value="Man" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#glcnac"</use>
	</svg>
	<input name="donor" value="glcnac" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neugc"</use>
	</svg>
	<input name="donor" value="neugc" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#glc"</use>
	</svg>
	<input name="donor" value="Glc" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#glca"</use>
	</svg>
	<input name="donor" value="GlcA" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#idoa"</use>
	</svg>
	<input name="donor" value="IdoA" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#xyl"</use>
	</svg>
	<input name="donor" value="Xyl" type="radio">
	</label>
	<label draggable="true" style="-webkit-user-drag: element; float: left;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#fuc"</use>
	</svg>
	<input name="donor" value="Fuc" type="radio">
	</label>
	</div>
	<div class="pie_parent">
	<x-piemenu name="anomer" id="anomer_menu" data-next="linkage_menu">
  <label><span>α</span><input name="anomer" value="a" type="radio"></label>
  <label><span>β</span><input name="anomer" value="b" type="radio"></label>
  <label><span>?</span><input name="anomer" value="?" type="radio"></label>
	</x-piemenu>
	<x-piemenu name="linkage" id="linkage_menu">
  <label><span>2</span><input name="linkage" value="2" type="radio"></label>
  <label><span>3</span><input name="linkage" value="3" type="radio"></label>
  <label><span>4</span><input name="linkage" value="4" type="radio"></label>
  <label><span>6</span><input name="linkage" value="6" type="radio"></label>
  <label><span>8</span><input name="linkage" value="8" type="radio"></label>
	</x-piemenu>
	</div>
	</form>
	</div>
	<textarea id="seq" style="display: none;" >Xyl</textarea>
	</div>

<script type="text/javascript">
	let ticking = false;
	window.addEventListener('scroll', function(e) {

	if (!ticking) {

		window.requestAnimationFrame(function() {
			let zoom = parseFloat((window.innerWidth / document.documentElement.clientWidth).toFixed(2));
			let top = window.scrollY;
			let left = window.scrollX;
			let palette = document.querySelector('#widget .palette');
			palette.style.transformOrigin = `${window.scrollX}px ${top}px`;
			let widget_pos = palette.parentNode.parentNode.getBoundingClientRect();
			if (widget_pos.top < 0 && widget_pos.left < 0) {
				palette.style.position = 'fixed';
			} else {
				palette.style.position = 'absolute';
			}

			if (zoom < 0.8) {
				left -= palette.parentNode.parentNode.offsetLeft/zoom;
				palette.style.width = (50/zoom)+'%';
			} else {
				palette.style.width='100%';
			}
			palette.style.transform = `scale(${zoom}) translate(${left}px,${top}px)`;
			document.querySelector('#widget .pie_parent').style.transformOrigin = `${window.scrollX}px ${top}px`;
			document.querySelector('#widget .pie_parent').style.transform = `scale(${zoom}) translate(${left}px,${top}px)`;
			ticking = false;
		});
		ticking = true;
	}
	});

	let clear_sequences = function() {
		document.getElementById('output').innerHTML = '';
	};

	const tag_symbol = Symbol('tageroony');

	let global_renderer;

	let append_sequence = function(seq) {
		if ( ! seq ) {
			return;
		}
		if ( ! global_renderer ) {
			global_renderer = new Glycan.SVGRenderer(document.getElementById('output'),Glycan.FishEyeLayout);
		}
		console.log(seq);
		let sug = new Glycan.IupacSugar();
		sug.sequence = seq;
		sug.root.setTag(tag_symbol);
		Glycan.FishEyeLayout.LINKS = true;
		let renderer = global_renderer;

		renderer.groupTag = tag_symbol;

		renderer.addSugar(sug);

		let last_req = null;

		renderer.element.canvas.addEventListener('dragleave', (ev) => {
			if (ev.relatedTarget === renderer.element.canvas) {
				setTimeout(() =>{
					document.getElementById('new_linkage').clear();
					delete document.getElementById('new_linkage').active_residue;
					delete document.getElementById('new_linkage').residue;
				},100);
				return;
			}
		});
		document.body.addEventListener('dragend', (ev) => {
			setTimeout(() =>{
				document.getElementById('new_linkage').reset();
			},100);

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.element.canvas.addEventListener('dragover', (ev) => {
			if (document.querySelectorAll('x-piemenu[active]').length > 0) {
				return;
			}

			Glycan.FishEyeLayout.focus = [ ev.svgX, ev.svgY ];
			let [min_x,min_y,width,height] = renderer.element.canvas.getAttribute('viewBox').split(' ').map( val => parseFloat(val) );
			let vp_zoom = parseFloat((window.innerWidth / document.documentElement.clientWidth).toFixed(2));
			let candidate_zoom = parseFloat((vp_zoom * vp_zoom * 3).toFixed(2));
			Glycan.FishEyeLayout.zoom = candidate_zoom < 0.1 ? 0.1 : candidate_zoom;
			Glycan.FishEyeLayout.lock_residues = true;
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.refresh();
		renderer.scaleToFit();
		sug.composition().map( enableDropResidue.bind(null,renderer) );
	};
	let load_all_seqs = function() {
		clear_sequences();
		for (let seq of document.getElementById('seqs').textContent.split('\n')) {
			append_sequence(seq.trim());
		}
		append_sequence(document.getElementById('seq').value);

	};

	show_anomer = function(residue,ev) {
		let anomer_chooser = document.getElementById('anomer_menu');
		let form = document.getElementById('new_linkage');
		form.clear && form.clear();
		console.log("Setting target to ",residue.identifier);
		delete form.active_residue;
		form.residue = residue;
		anomer_chooser.removeAttribute('active');
		let zoom = parseFloat((window.innerWidth / document.documentElement.clientWidth).toFixed(2));
		let target_pos = ev.target.getBoundingClientRect();
		let vals = { top: target_pos.top ,left: target_pos.left ,width: target_pos.width ,height: target_pos.height };
		let anomer_size = anomer_chooser.getBoundingClientRect();
		let palette_top = (anomer_chooser.parentNode.getBoundingClientRect().top/zoom);
		let palette_left = (anomer_chooser.parentNode.getBoundingClientRect().left/zoom);

		let left_pos = (((vals.left + 0.5*vals.width - 0.5*anomer_size.width)/zoom) - palette_left).toFixed(2);
		let top_pos = (((vals.top+0.5*vals.height  - 0.5*anomer_size.height)/zoom) - palette_top).toFixed(2);

		anomer_chooser.style.transformOrigin = `${left_pos}px ${top_pos}px`;
		anomer_chooser.style.transform = `scale(1) translate(${left_pos}px,${top_pos}px)`;
		anomer_chooser.setAttribute('active',true);
		anomer_chooser.clear();
	};

	enableDropResidue = function(renderer,residue) {
		residue.renderer = renderer;
		let target = renderer.rendered.get(residue).residue;
		target.style.pointerEvents = 'all';
		let form = document.getElementById('new_linkage');

		target.addEventListener('dragleave', (ev) => {
			delete form.active_residue;
		});
		target.addEventListener('click', show_anomer.bind(null,residue) );
		target.addEventListener('dragenter', (ev) => {
			if (form.residue === residue) {
				return;
			}

			if (form.active_residue === residue) {
				return;
			}

			form.clear();

			// We should wait for a drag over at least 300 ms after
			// to set the target
			form.active_residue = residue;

			if (form.menu_timeout) {
				clearTimeout(form.menu_timeout);
			}

			form.menu_timeout = setTimeout(show_anomer.bind(null,residue,ev),500);
		});
	};

	window.onload = function() {
		new Glycan.DragManager(document.body);
		new Glycan.DraggableForm(document.getElementById('new_linkage'));
		document.getElementById('new_linkage').addEventListener('change', function(ev) {
			if (ev.target && ev.target.parentNode instanceof HTMLLabelElement) {
				let targ = ev.target;
				if (targ.name !== 'donor') {
					return;
				}
				for (let sib of this[targ.name]) {
					if (sib === targ) {
						sib.parentNode.classList.add('checked');
					} else {
						sib.parentNode.classList.remove('checked');
					}
				}
			}
		});
		document.getElementById('new_linkage').addEventListener('reset', function(ev) {
			delete this.residue;

			for (let sib of this['donor']) {
				sib.parentNode.classList.remove('checked');
			}

		});
		document.getElementById('new_linkage').addEventListener('submit', function(ev) {
			let new_res = new Glycan.Monosaccharide(this.donor.value);
			new_res.anomer = this.anomer.value;
			new_res.parent_linkage = this.donor.value.match(/Neu(Gc|Ac)/) ? 2 : 1;
			this.residue.addChild(parseInt(this.linkage.value),new_res);
			this.residue.balance();
			this.residue.renderer.refresh();
			enableDropResidue(this.residue.renderer,new_res);
			this.residue.renderer.scaleToFit();
			console.log(this.residue.renderer.sugars[0].sequence);
			this.reset();
		});

		load_all_seqs();
		document.getElementById('seq').onchange = function() {
			load_all_seqs();
		};
	};
</script>

</body>
</html>