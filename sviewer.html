<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,shrink-to-fit=no"/>
	<title>Sviewer</title>
	<script type="text/javascript" src="webcomponents-lite.js"></script>
	<script type="text/javascript" src="node_modules/babel-polyfill/dist/polyfill.js"></script>
	<script type="text/javascript" src="dragdroptouch.js"></script>
 	<script type="text/javascript" src="glycan-bundle.js"></script>

 <style type="text/css">
#output svg * {
  -moz-transition: all 0.5s ease-in-out;
  -o-transition: all 0.5s ease-in-out;
  -webkit-transition: all 0.5s ease-in-out;
  transition: all 0.5s ease-in-out;
}
g.tagged {
	filter: url(#membrane);
}
g.tagged line {
	stroke-width: 5;
}
.palette div {
	height: 100%;
}
body {
  margin: 0px;
  margin-top: 40px;
  margin-left: 20px;
  /* Disables pull-to-refresh but allows overscroll glow effects. */
  /*overscroll-behavior-y: contain;*/
/*  position: fixed;
*/  overflow: hidden;
}
x-piemenu {
	position: absolute;
	top: 0px;
	left: 0px;
	pointer-events: none;
	width: 150px;
	height: 150px;
}
x-piemenu[active] label {
	pointer-events: all;
}
x-piemenu button, x-piemenu label {
	font-family: sans-serif;
	font-size: 8px;
}
x-piemenu button.hover, x-piemenu label.hover, x-piemenu button:hover, x-piemenu label:hover {
	background: #6052E2;
	color: #ffffff;
}
</style>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1000 1000" width="0" height="0">
	<defs>
    <filter id="membrane" filterUnits="objectBoundingBox">
      <feColorMatrix mode="matrix" in="SourceGraphic" values="0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 1 0" result="blacksource"/>
      <feGaussianBlur in="blacksource" stdDeviation="3" result="blur" />
      <feColorMatrix mode="matrix" in="blur" values="0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 0 0
                                                     0 0 0 20 -3" result="contrastup"/>

      <feColorMatrix mode="matrix" in="contrastup" values="0 0 0 0 0.8
                                                     0 0 0 0 0.8
                                                     0 0 0 0 0.9
                                                     0 0 0 1 0" result="googrey"/>
      <feMorphology operator="dilate" in="googrey" radius="15"/>
          <feColorMatrix mode="matrix" values="0 0 0 0 0.6
0 0 0 0 0.6
0 0 0 0 0.9
0 0 0 1 0" result="outeroutline"/>
      <feComposite in2="outeroutline" in="googrey" result="gooback"/>
      <feComposite in2="gooback" in="SourceGraphic"/>
	</filter>
	</defs>
</svg>
	<form id="new_linkage">
	<x-piemenu id="anomer_menu" >
  <label><span>a</span><input name="anomer" value="a" type="radio"></label>
  <label><span>b</span><input name="anomer" value="b" type="radio"></label>
  <label><span>?</span><input name="anomer" value="?" type="radio"></label>
	</x-piemenu>
	<x-piemenu id="linkage_menu">
  <label><span>2</span><input name="linkage" value="2" type="radio"></label>
  <label><span>3</span><input name="linkage" value="3" type="radio"></label>
  <label><span>4</span><input name="linkage" value="4" type="radio"></label>
  <label><span>6</span><input name="linkage" value="6" type="radio"></label>
  <label><span>8</span><input name="linkage" value="8" type="radio"></label>
	</x-piemenu>
	</form>
	<pre id="seqs" style="display: none;">
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc
		Gal(b1-3)[GlcNAc(b1-4)]GalNAc
		NeuAc(a2-6)[Fuc(a1-4)]Gal(b1-4)GlcNAc(b1-3)[NeuAc(a2-6)Gal(b1-4)GlcNAc(b1-6)]Gal(b1-4)GlcNAc(b1-2)Gal(b1-4)Glc
		NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-4)[NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Gal(b1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)[NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
		Fuc(a1-2)[NeuAc(a2-3)]GalNAc(b1-4)GlcNAc(b1-2)GalNAc(b1-4)GlcNAc(b1-2)[Fuc(a1-2)[NeuAc(a2-3)]Gal(b1-3)GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-6)]Man(a1-3)[GlcNAc(b1-4)][NeuAc(a2-3)Gal(b1-3)[Fuc(a1-4)]GlcNAc(b1-2)Gal(b1-3)GlcNAc(b1-2)Man(a1-6)]Man(b1-4)GlcNAc(b1-4)[Fuc(a1-6)]GlcNAc
	</pre>
	<div class="palette" style="position: absolute; top: 0px; left: 0px; background-color: black; right: 0px; height: 50px;">
	<div draggable="true" id="dragsource" style="-webkit-user-drag: element; width: 50px; height: 50px;">
	<svg width="100%" height="100%" viewBox="0 0 100 100">
		<use x="0.0" y="0.0" width="100" height="100" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="sugars.svg#neuac"</use>
	</svg>
	</div>
	</div>
	<textarea id="seq" style="display: none;" >NeuAc(a2-3)[GlcA(b1-?)]Gal(b1-4)Fuc</textarea>
	<div id="output">
	</div>
<script type="text/javascript">
	let ticking = false;
	window.addEventListener('scroll', function(e) {

	  if (!ticking) {

	    window.requestAnimationFrame(function() {
		  let zoom = (window.innerWidth / document.documentElement.clientWidth).toFixed(2);
	      let top = window.scrollY;
	      document.getElementById('dragsource').parentNode.style.transformOrigin = `${window.scrollX}px ${top}px`;
		  document.getElementById('dragsource').parentNode.style.transform = `scale(${zoom}) translate(${window.scrollX}px,${top}px)`;
		  // console.log(document.getElementById('dragsource').style.transform);
	      ticking = false;
	    });
	     
	    ticking = true;

	  }
	  
	});

	let clear_sequences = function() {
		document.getElementById('output').innerHTML = '';
	};

	const tag_symbol = Symbol('tageroony');

	let append_sequence = function(seq) {
		if ( ! seq ) {
			return;
		}
		console.log(seq);
		let sug = new Glycan.IupacSugar();
		sug.sequence = seq;
		sug.root.setTag(tag_symbol);
		sug.root.children[0].setTag(tag_symbol);
		if (sug.root.children[0].children.length > 0) {
			sug.root.children[0].children[0].setTag(tag_symbol);
		}
		let output = document.createElement('div');
		output.style.width = '150px';
		output.style.height = '150px';
		output.style.float = 'left';
		document.getElementById('output').appendChild(output);
		Glycan.FishEyeLayout.LINKS = false;
		let renderer = new Glycan.SVGRenderer(output,Glycan.FishEyeLayout);

		renderer.groupTag = tag_symbol;

		renderer.addSugar(sug);

		let last_req = null;

		renderer.element.canvas.addEventListener('dragleave', (ev) => {
			if (ev.relatedTarget === renderer.element.canvas) {
				setTimeout(() =>{
					document.getElementById('anomer_menu').removeAttribute('active');
					document.getElementById('linkage_menu').removeAttribute('active');
					delete document.getElementById('new_linkage').residue;
				},100);
			}

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});
		document.body.addEventListener('dragend', (ev) => {
			setTimeout(() =>{
				document.getElementById('anomer_menu').removeAttribute('active');
				document.getElementById('linkage_menu').removeAttribute('active');
				delete document.getElementById('new_linkage').residue;
			},100);

			Glycan.FishEyeLayout.focus = [ -1000, -1000 ];
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		renderer.element.canvas.addEventListener('dragover', (ev) => {
			if (
			document.getElementById('linkage_menu').hasAttribute('active') ||
			document.getElementById('anomer_menu').hasAttribute('active') ) {
				return;
			}

			Glycan.FishEyeLayout.focus = [ ev.svgX, ev.svgY ];
			let [min_x,min_y,width,height] = renderer.element.canvas.getAttribute('viewBox').split(' ').map( val => parseFloat(val) );
			Glycan.FishEyeLayout.zoom = Math.floor(height / 100);
			Glycan.FishEyeLayout.lock_residues = true;
			if (last_req) {
				cancelAnimationFrame(last_req);
			}
			last_req = requestAnimationFrame(function() {
				renderer.refresh();
			});
		});

		// setInterval(function() {
		// 	if ( Math.floor(Math.random()*10) >= 5 ) {
		// 		if (sug.composition().length < 3) {
		// 			return;
		// 		}
		// 		let removed = sug.leaves()[0];
		// 		removed.parent.removeChild(removed.parent.linkageOf(removed),removed);
		// 	} else {
		// 		let residues = sug.composition();
		// 		let targ = residues[Math.floor(Math.random()*residues.length)];
		// 		if (targ.identifier === 'Fuc' || targ.identifier === 'NeuAc') {
		// 			return;
		// 		}
		// 		let new_res = new Glycan.Monosaccharide('Gal');
		// 		new_res.anomer = 'a';
		// 		new_res.parent_link = 1;
		// 		targ.addChild(4,new_res);
		// 		targ = new_res;
		// 	}
		// 	renderer.refresh();
		// },1000);
		renderer.refresh();
		sug.composition().map( enableDropResidue.bind(null,renderer) );
		output.firstChild.style.width = '100%';
		output.firstChild.style.height = '100%';
	};
	let load_all_seqs = function() {
		clear_sequences();
		console.log("Here");
		for (let seq of document.getElementById('seqs').textContent.split('\n')) {
			append_sequence(seq.trim());
		}
		append_sequence(document.getElementById('seq').value);

	};

	document.getElementById('dragsource').addEventListener('dragstart', function (evt) {
		evt.stopPropagation();
		// If we'd like to prevent dragging because of some condition,
		// we'd simply call preventDefault() and be done here
		if (false) {
		  evt.preventDefault();
		  return;
		}
		evt.data.residue = 'NeuAc';
		evt.data.visited = [];
	});

	document.getElementById('dragsource').addEventListener('dragend', (evt) => {
		document.getElementById('linkage_menu').removeAttribute('active');
		document.getElementById('anomer_menu').removeAttribute('active');
		delete document.getElementById('new_linkage').residue;
	});

	unselectMenu = function(menu) {
		for (let kid of menu.children) {
			kid.classList.remove('hover');
		}
	};

	let svgPosition = function(el) {
		let point = el.ownerSVGElement.createSVGPoint();
		let el_bbox = el.getTransformedBB();
		point.x = (el_bbox.x + 0.5*el_bbox.width);
		point.y = (el_bbox.y + 0.5*el_bbox.height);
		console.log(el_bbox,point);
		let transformed = point.matrixTransform(el.ownerSVGElement.getScreenCTM());
		console.log(transformed);
		return { top: transformed.y, left: transformed.x };
	};

	enableDropResidue = function(renderer,residue) {
		residue.renderer = renderer;
		let target = renderer.rendered.get(residue).residue;
		target.style.pointerEvents = 'all';
		let anomer_chooser = document.getElementById('anomer_menu');
		let linkage_chooser = document.getElementById('linkage_menu');
		let last_anomer = null;
		let anomer_timeout = null;
		if (! anomer_chooser.wired ) {
		anomer_chooser.addEventListener('dragenter', (ev) => {
			let targ = ev.target;
			if ( ! (targ instanceof HTMLLabelElement) ) {
				return;
			}
			if (targ === last_anomer) {
				return;
			}
			last_anomer = targ;
			for (let sib of targ.parentNode.children) {
				if (sib !== targ) {
					sib.classList.remove('hover');
				} else {
					sib.classList.add('hover');
				}
			}
			if (anomer_timeout) {
				// Also clear this out for a dragend or a dragleave
				clearTimeout(anomer_timeout);
			}
			anomer_timeout = setTimeout( () => {
				if ( ! last_anomer ) {
					return;
				}
				last_anomer.click();
				last_anomer = null;
				last_linkage = null;
				anomer_chooser.removeAttribute('active');
				linkage_chooser.setAttribute('active',true);
				unselectMenu(linkage_chooser);
			},700);
		});
		anomer_chooser.addEventListener('dragleave', (ev) => {
			if (ev.relatedTarget !== anomer_chooser) {
				return;
			}
			console.log("Left the anomer chooser");
			last_anomer = null;
			last_linkage = null;
			delete document.getElementById('new_linkage').residue;

			anomer_chooser.removeAttribute('active');
		});

		}
		let last_linkage = null;
		let linkage_timeout = null;
		if (! linkage_chooser.wired) {
			linkage_chooser.addEventListener('dragleave', (ev) => {
				if (ev.relatedTarget !== linkage_chooser) {
					return;
				}
				console.log("Left the linkage chooser");
				last_anomer = null;
				last_linkage = null;
				delete document.getElementById('new_linkage').residue;
				linkage_chooser.removeAttribute('active');
			});

			linkage_chooser.addEventListener('dragover', (ev) => {
				ev.preventDefault();
			});
			linkage_chooser.addEventListener('dragenter', (ev) => {
				ev.preventDefault();
				let targ = ev.target;
				if ( ! (targ instanceof HTMLLabelElement) ) {
					return;
				}
				if (targ === last_linkage) {
					return;
				}
				last_linkage = targ;
				for (let sib of targ.parentNode.children) {
					if (sib !== targ) {
						sib.classList.remove('hover');
					} else {
						sib.classList.add('hover');
					}
				}
				if (linkage_timeout) {
					// Also clear this out for a dragend or a dragleave
					clearTimeout(linkage_timeout);
				}
				last_linkage.click();
			});

			linkage_chooser.addEventListener('drop', (ev) => {
				let residue = document.getElementById('new_linkage').residue;
				// console.log(JSON.stringify([...new FormData(document.getElementById('new_linkage'))]));
				console.log(residue.identifier);
				let new_mono = new Glycan.Monosaccharide('NeuAc');
				new_mono.anomer = document.getElementById('new_linkage').anomer.value;
				residue.addChild(document.getElementById('new_linkage').linkage.value,new_mono);
				residue.renderer.refresh();
				enableDropResidue(residue.renderer,new_mono);
				delete document.getElementById('new_linkage').residue;
				last_linkage = null;
				last_anomer = null;
			},{capture: false});

		}
		anomer_chooser.wired = true;
		linkage_chooser.wired = true;
		target.addEventListener('dragleave', (ev) => {
			let target_form = document.getElementById('new_linkage');
			console.log("Leaving ",residue.identifier);
			delete target_form.active_residue;
			clearTimeout(target_form.residue_timeout);
		});
		target.addEventListener('dragenter', (ev) => {
			let target_form = document.getElementById('new_linkage');
			let last_residue = target_form.active_residue;
			if (last_residue === residue) {
				return;
			}

			// We should wait for a drag over at least 300 ms after
			// to set the target
			last_residue = residue;
			target_form.active_residue = residue;

			if (target_form.residue_timeout) {
				clearTimeout(target_form.residue_timeout);
			}

			target_form.residue_timeout = setTimeout(() => {
				console.log("Setting target to ",residue.identifier);
				delete target_form.active_residue;
				target_form.residue = residue;
				linkage_chooser.removeAttribute('active');
				anomer_chooser.removeAttribute('active');
				let target_pos = ev.target.getBoundingClientRect();
				let left_pos = -0.5*anomer_chooser.getBoundingClientRect().width + target_pos.left + (target_pos.width / 2) + window.scrollX;
				let top_pos = -0.5*anomer_chooser.getBoundingClientRect().height + target_pos.top + (target_pos.height / 2) + window.scrollY;
				let zoom = (window.innerWidth / document.documentElement.clientWidth).toFixed(2);
				anomer_chooser.style.transformOrigin = `${left_pos}px ${top_pos}px`;
				anomer_chooser.style.transform = `scale(${zoom}) translate(${left_pos}px,${top_pos}px)`;
				linkage_chooser.style.transformOrigin = `${left_pos}px ${top_pos}px`;
				linkage_chooser.style.transform = `scale(${zoom}) translate(${left_pos}px,${top_pos}px)`;
				anomer_chooser.setAttribute('active',true);
				unselectMenu(anomer_chooser);
			},500);
		});
	};

	makeDragTarget = function(element) {
		element.style.pointerEvents = 'all';
		element.addEventListener('dragover', ev => ev.preventDefault() );
		element.addEventListener('dragenter', (ev) => {
			ev.preventDefault();
			if (ev.data.visited.indexOf(element.getAttribute('glycanjs:identifier')) < 0) {
				ev.data.visited.push(element.getAttribute('glycanjs:identifier'));
			}
		});
		element.addEventListener('drop', (ev) => {
			console.log(ev.data);
		},{capture: false, passive: true});
	};

	window.onload = function() {
		new Glycan.DragManager(document.body);
		load_all_seqs();
		document.getElementById('seq').onchange = function() {
			load_all_seqs();
		};
	};
</script>

</body>
</html>